<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Anonymous Chat - #chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Cousine:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer"/>
    
    <style>
        body {
            font-family: 'Cousine', monospace;
            background-color: #000;
        }
        .chat-container {
            max-width: 600px;
            height: 100vh;
        }
        .form-input {
            background-color: rgba(255,255,255,.1);
            border: 1px solid rgba(255,255,255,.2);
            color: #fff;
            transition: all .3s ease;
        }
        .form-input:focus {
            background-color: rgba(255,255,255,.15);
            border-color: rgba(255,255,255,.4);
            box-shadow: 0 0 0 2px rgba(255,255,255,.1);
        }
        .message-bubble {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 8px 12px;
            word-wrap: break-word; 
            word-break: break-word; 
            overflow-wrap: break-word;
        }
        #messages {
            overflow-y: auto;
            max-height: calc(100vh - 120px); 
            height: 100%;
            scroll-behavior: smooth;
        }
        #messages::-webkit-scrollbar { width: 6px; }
        #messages::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 3px; }
        #messages::-webkit-scrollbar-track { background: transparent; }
        
        .image-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 8px;
            object-fit: contain;
        }

        .loading-pulse {
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body class="p-0 text-white min-h-screen flex justify-center">

    <div class="chat-container flex flex-col mx-auto">
        <div class="p-4 border-b border-white/10 flex items-center justify-between sticky top-0 bg-black z-10">
            <h1 class="text-xl font-bold tracking-wider text-white">#chat</h1>
            <span id="user-info" class="text-sm text-gray-400">Connecting...</span>
        </div>

        <!-- FILE PREVIEW SEBELUM KIRIM -->
        <div id="file-preview-container" class="px-4 pt-2 hidden">
            <div class="relative rounded-lg overflow-hidden border border-white/20">
                <img id="preview-image" class="image-preview w-full" style="display: none;">
                <video id="preview-video" class="image-preview w-full" style="display: none;" controls></video>
                <audio id="preview-audio" class="w-full mt-2" style="display: none;" controls></audio>
                <div id="preview-file-info" class="bg-white/5 p-3 text-xs text-gray-300" style="display: none;"></div>
            </div>
            <div class="mt-2 flex gap-2">
                <button type="button" id="remove-preview" class="text-xs bg-red-900/50 px-3 py-1 rounded hover:bg-red-800/50">Remove</button>
            </div>
        </div>

        <!-- LOADING BAR SAAT UPLOAD -->
        <div id="upload-progress" class="px-4 pt-2 hidden">
            <div class="text-xs text-gray-400 mb-1">Uploading...</div>
            <div class="w-full h-2 bg-gray-700 rounded overflow-hidden">
                <div id="progress-bar" class="h-full bg-blue-500 transition-all duration-200" style="width: 0%;"></div>
            </div>
        </div>

        <div id="messages" class="flex-1 p-4 space-y-4 pb-24"></div>

        <div class="p-4 border-t border-white/10 fixed bottom-0 left-1/2 transform -translate-x-1/2 bg-black z-10 w-full max-w-[600px]">
            <form id="message-form" class="flex space-x-2">
                <input type="file" id="file-upload" accept="image/*,video/*,audio/*,.pdf,.txt,.zip" class="hidden">
                <button type="button" id="upload-button" class="form-input p-3 hover:bg-white/20 transition-colors" title="Attach File">
                    <i class="fa-solid fa-paperclip"></i>
                </button>

                <input type="text" id="message-input" 
                       placeholder="Type a message..." 
                       class="form-input flex-1 py-3 px-4 text-sm"
                       autocomplete="off">
                
                <button type="submit" id="send-button" class="bg-white/10 text-white p-3 hover:bg-white/20 transition-colors" disabled>
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </form>
        </div>
    </div>

    <script>
        // ==================== SECURITY: STRICT INPUT SANITIZATION ====================
        
        function sanitizeText(text) {
            // Hanya allow plain text, NO HTML TAGS ALLOWED
            if (typeof text !== 'string') return '';
            return text.replace(/[<>\"'&]/g, char => ({
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;',
                '&': '&amp;'
            }[char]));
        }

        function isValidUrl(string) {
            try {
                const url = new URL(string);
                return url.protocol === 'https:' || url.protocol === 'http:';
            } catch (_) {
                return false;
            }
        }

        // ==================== UTILITY ====================
        
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // ==================== STATE ====================
        
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const messagesDiv = document.getElementById('messages');
        const userInfoSpan = document.getElementById('user-info');
        const uploadButton = document.getElementById('upload-button');
        const fileUpload = document.getElementById('file-upload');
        const sendButton = document.getElementById('send-button');
        
        const filePreviewContainer = document.getElementById('file-preview-container');
        const previewImage = document.getElementById('preview-image');
        const previewVideo = document.getElementById('preview-video');
        const previewAudio = document.getElementById('preview-audio');
        const previewFileInfo = document.getElementById('preview-file-info');
        const removePreviewBtn = document.getElementById('remove-preview');
        
        const uploadProgress = document.getElementById('upload-progress');
        const progressBar = document.getElementById('progress-bar');

        let anonymousId = null;
        let isUploading = false;
        let selectedFile = null;
        let messageCount = 0;

        const MAX_FILE_SIZE = 6 * 1024 * 1024;

        // ==================== DISPLAY MESSAGE dengan SECURITY ====================
        
        function displayMessage(data, isNewMessage = false) {
            if (!data || !data.name) return;

            const messageElement = document.createElement('div');
            messageElement.className = 'flex flex-col';
            
            const isSelf = data.anonymousId == anonymousId;
            const nameClass = isSelf ? 'text-blue-400 font-bold' : 'text-gray-400';
            const bubbleClass = isSelf ? 'self-end bg-blue-900/40' : 'self-start bg-white/10';
            
            const time = data.timestamp ? new Date(data.timestamp).toLocaleTimeString() : '...';

            // SECURITY: SANITIZE ALL TEXT - NO EXCEPTIONS
            const sanitizedName = sanitizeText(data.name);
            const sanitizedText = sanitizeText(data.text || '');

            // Create name span with textContent only
            const nameElement = document.createElement('span');
            nameElement.className = `text-xs ${nameClass} mb-1`;
            nameElement.textContent = `${sanitizedName} (${time})`;

            const bubbleElement = document.createElement('div');
            bubbleElement.className = `message-bubble ${bubbleClass} max-w-[85%]`;

            if (sanitizedText) {
                const textElement = document.createElement('p');
                textElement.className = 'text-sm';
                textElement.textContent = sanitizedText; // SAFE: textContent, tidak innerHTML
                bubbleElement.appendChild(textElement);
            }
            
            // File attachment - ONLY show safe URLs
            if (data.fileUrl && data.fileName && isValidUrl(data.fileUrl)) {
                const fileType = data.fileName.split('.').pop().toLowerCase();
                const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(fileType);
                const isVideo = ['mp4', 'webm', 'ogg'].includes(fileType);
                const isAudio = ['mp3', 'wav', 'ogg'].includes(fileType);

                if (isImage) {
                    const img = document.createElement('img');
                    img.src = data.fileUrl;
                    img.className = 'image-preview w-full';
                    img.alt = 'Image'; // Safe alt text
                    bubbleElement.appendChild(img);
                } else if (isVideo) {
                    const video = document.createElement('video');
                    video.src = data.fileUrl;
                    video.controls = true;
                    video.className = 'image-preview w-full';
                    bubbleElement.appendChild(video);
                } else if (isAudio) {
                    const audio = document.createElement('audio');
                    audio.src = data.fileUrl;
                    audio.controls = true;
                    audio.className = 'w-full mt-2';
                    bubbleElement.appendChild(audio);
                } else {
                    // File link - safe text only
                    const fileLink = document.createElement('a');
                    fileLink.href = data.fileUrl;
                    fileLink.target = '_blank';
                    fileLink.rel = 'noopener noreferrer';
                    fileLink.className = 'text-yellow-400 hover:underline text-xs mt-2 block';
                    fileLink.textContent = `📎 ${sanitizeText(data.fileName)}${data.fileSize ? ` (${formatBytes(data.fileSize)})` : ''}`;
                    bubbleElement.appendChild(fileLink);
                }
            }

            messageElement.appendChild(nameElement);
            messageElement.appendChild(bubbleElement);
            messagesDiv.appendChild(messageElement);
            
            // HANYA scroll kalo message baru, tidak tiap kali render
            if (isNewMessage) {
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        }

        // ==================== PREVIEW FILE SEBELUM KIRIM ====================
        
        function showPreview(file) {
            if (!file) {
                filePreviewContainer.classList.add('hidden');
                previewImage.style.display = 'none';
                previewVideo.style.display = 'none';
                previewAudio.style.display = 'none';
                previewFileInfo.style.display = 'none';
                return;
            }

            filePreviewContainer.classList.remove('hidden');
            const fileType = file.type;
            const fileName = file.name;

            previewImage.style.display = 'none';
            previewVideo.style.display = 'none';
            previewAudio.style.display = 'none';
            previewFileInfo.style.display = 'none';

            if (fileType.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImage.src = e.target.result;
                    previewImage.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else if (fileType.startsWith('video/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewVideo.src = e.target.result;
                    previewVideo.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else if (fileType.startsWith('audio/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewAudio.src = e.target.result;
                    previewAudio.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                const info = document.createElement('div');
                info.textContent = `📄 ${sanitizeText(fileName)} (${formatBytes(file.size)})`;
                previewFileInfo.innerHTML = '';
                previewFileInfo.appendChild(info);
                previewFileInfo.style.display = 'block';
            }
        }

        // ==================== FILE UPLOAD ====================
        
        async function uploadFileToApi(file) {
            if (!file || file.size > MAX_FILE_SIZE) {
                alert(`File too large! Max: ${formatBytes(MAX_FILE_SIZE)}`);
                return null;
            }

            isUploading = true;
            uploadProgress.classList.remove('hidden');
            progressBar.style.width = '0%';

            try {
                const base64 = await fileToBase64(file);
                
                // Simulate upload dengan progress
                for (let i = 0; i <= 100; i += 10) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    progressBar.style.width = `${i}%`;
                }

                // Ganti dengan actual API call
                const response = await fetch('/api/upload-file', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ file: base64 })
                });

                const data = await response.json();
                if (data.success && data.url && isValidUrl(data.url)) {
                    progressBar.style.width = '100%';
                    await new Promise(resolve => setTimeout(resolve, 500));
                    return data.url;
                } else {
                    throw new Error('Upload failed');
                }
            } catch (error) {
                console.error('Upload error:', error);
                progressBar.style.width = '0%';
                alert(`Upload failed: ${error.message}`);
                return null;
            } finally {
                isUploading = false;
                uploadProgress.classList.add('hidden');
                progressBar.style.width = '0%';
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // ==================== EVENT LISTENERS ====================

        function updateSendButtonState() {
            const hasText = messageInput.value.trim() !== '';
            const hasFile = selectedFile !== null;
            sendButton.disabled = !(hasText || hasFile) || isUploading;
        }

        uploadButton.addEventListener('click', () => {
            fileUpload.click();
        });

        messageInput.addEventListener('input', () => {
            updateSendButtonState();
        });

        fileUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            selectedFile = file;
            
            if (file && file.size <= MAX_FILE_SIZE) {
                showPreview(file);
                updateSendButtonState();
            } else if (file) {
                alert(`File too large! Max: ${formatBytes(MAX_FILE_SIZE)}`);
                selectedFile = null;
                fileUpload.value = '';
                filePreviewContainer.classList.add('hidden');
                updateSendButtonState();
            }
        });

        removePreviewBtn.addEventListener('click', () => {
            selectedFile = null;
            fileUpload.value = '';
            filePreviewContainer.classList.add('hidden');
            updateSendButtonState();
        });

        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const messageText = messageInput.value.trim();
            const file = selectedFile;

            if (!messageText && !file) return;
            if (isUploading) return;

            messageInput.disabled = true;
            sendButton.disabled = true;
            uploadButton.disabled = true;
            
            let fileUrl = null;
            
            if (file) {
                fileUrl = await uploadFileToApi(file);
                if (!fileUrl && !messageText) {
                    messageInput.disabled = false;
                    uploadButton.disabled = false;
                    updateSendButtonState();
                    return;
                }
            }

            // Send message
            if (messageText || fileUrl) {
                messageCount++;
                const newMessage = {
                    name: `Anonymous #${anonymousId}`,
                    anonymousId: anonymousId,
                    text: messageText,
                    timestamp: Date.now(),
                    fileUrl: fileUrl,
                    fileName: file ? file.name : null,
                    fileSize: file ? file.size : null
                };
                displayMessage(newMessage, true); // true = scroll ke bawah
            }
            
            messageInput.value = '';
            selectedFile = null;
            fileUpload.value = '';
            filePreviewContainer.classList.add('hidden');
            
            messageInput.disabled = false;
            uploadButton.disabled = false;
            updateSendButtonState();
            messageInput.focus();
        });

        // ==================== INITIALIZE ====================
        anonymousId = Math.floor(Math.random() * 10000);
        userInfoSpan.textContent = `You are Anonymous #${anonymousId}`;
        
        // Demo: Add initial message
        setTimeout(() => {
            displayMessage({
                name: 'Anonymous #5555',
                anonymousId: '5555',
                text: 'Welcome to #chat! This is a secure, anonymous chat.',
                timestamp: Date.now()
            }, false); // false = jangan scroll
        }, 500);
    </script>
</body>
</html>
